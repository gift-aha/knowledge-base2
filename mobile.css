// ==================== 移动端样式管理组件 ====================
const MobileStyleManager = {
    currentTheme: 'default',
    themes: {
        default: {
            name: '默认主题',
            variables: {
                '--primary-color': '#4a6fa5',
                '--secondary-color': '#6b8cbc',
                '--bg-color': '#f5f7fa',
                '--card-bg': '#ffffff',
                '--text-color': '#333333',
                '--border-color': '#e1e5eb',
                '--warning-bg': '#fff8e1',
                '--button-radius': '12px',
                '--font-family': "'PingFang SC', 'Helvetica Neue', Arial, sans-serif"
            }
        },
        dark: {
            name: '深色模式',
            variables: {
                '--primary-color': '#64b5f6',
                '--secondary-color': '#90caf9',
                '--bg-color': '#121212',
                '--card-bg': '#1e1e1e',
                '--text-color': '#e0e0e0',
                '--border-color': '#333333',
                '--warning-bg': '#2d2d00',
                '--button-radius': '12px',
                '--font-family': "'PingFang SC', 'Helvetica Neue', Arial, sans-serif"
            }
        },
        warm: {
            name: '暖色护眼',
            variables: {
                '--primary-color': '#d68c45',
                '--secondary-color': '#e8b886',
                '--bg-color': '#fef6e6',
                '--card-bg': '#fffaf0',
                '--text-color': '#5c4636',
                '--border-color': '#e8d8c3',
                '--warning-bg': '#fff4e6',
                '--button-radius': '14px',
                '--font-family': "'KaiTi', 'STKaiti', serif"
            }
        },
        compact: {
            name: '紧凑模式',
            variables: {
                '--primary-color': '#4a6fa5',
                '--secondary-color': '#6b8cbc',
                '--bg-color': '#ffffff',
                '--card-bg': '#ffffff',
                '--text-color': '#333333',
                '--border-color': '#d0d0d0',
                '--warning-bg': '#f5f5f5',
                '--button-radius': '8px',
                '--font-family': "'PingFang SC', 'Helvetica Neue', Arial, sans-serif"
            }
        },
        professional: {
            name: '专业蓝调',
            variables: {
                '--primary-color': '#2c5282',
                '--secondary-color': '#4299e1',
                '--bg-color': '#edf2f7',
                '--card-bg': '#ffffff',
                '--text-color': '#2d3748',
                '--border-color': '#cbd5e0',
                '--warning-bg': '#ebf8ff',
                '--button-radius': '10px',
                '--font-family': "'Segoe UI', 'Roboto', sans-serif"
            }
        },
        highContrast: {
            name: '高对比度',
            variables: {
                '--primary-color': '#000000',
                '--secondary-color': '#ffffff',
                '--bg-color': '#ffffff',
                '--card-bg': '#ffffff',
                '--text-color': '#000000',
                '--border-color': '#000000',
                '--warning-bg': '#ffff00',
                '--button-radius': '0px',
                '--font-family': "'Arial Black', 'Arial', sans-serif"
            }
        }
    },
    
    init: function() {
        this.loadTheme();
        this.applyTheme();
        this.injectBaseStyles();
        this.createThemeSwitcher();
    },
    
    loadTheme: function() {
        const savedTheme = localStorage.getItem('mobileTheme') || 'default';
        this.currentTheme = savedTheme;
    },
    
    saveTheme: function(theme) {
        this.currentTheme = theme;
        localStorage.setItem('mobileTheme', theme);
    },
    
    applyTheme: function(theme = this.currentTheme) {
        const themeVars = this.themes[theme].variables;
        const root = document.documentElement;
        
        Object.keys(themeVars).forEach(variable => {
            root.style.setProperty(variable, themeVars[variable]);
        });
        
        this.saveTheme(theme);
        this.updateThemeSwitcherUI();
    },
    
    injectBaseStyles: function() {
        const styleId = 'mobile-optimized-styles';
        if (document.getElementById(styleId)) return;
        
        const style = document.createElement('style');
        style.id = styleId;
        style.textContent = `
            /* 移动端优化基础样式 */
            :root {
                --primary-color: #4a6fa5;
                --secondary-color: #6b8cbc;
                --bg-color: #f5f7fa;
                --card-bg: #ffffff;
                --text-color: #333333;
                --border-color: #e1e5eb;
                --warning-bg: #fff8e1;
                --button-radius: 12px;
                --font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            }
            
            body {
                font-family: var(--font-family);
                background-color: var(--bg-color);
                color: var(--text-color);
                line-height: 1.5;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
                overflow-x: hidden;
            }
            
            /* 触摸友好的按钮 */
            button, .btn, .mobile-btn {
                min-height: 44px;
                min-width: 44px;
                padding: 12px 20px;
                font-size: 16px;
                border-radius: var(--button-radius);
                border: none;
                background-color: var(--primary-color);
                color: white;
                cursor: pointer;
                user-select: none;
                transition: all 0.2s ease;
                touch-action: manipulation;
                margin: 4px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            }
            
            button:hover, .btn:hover, .mobile-btn:hover {
                background-color: var(--secondary-color);
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }
            
            button:active, .btn:active, .mobile-btn:active {
                transform: translateY(0);
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            
            /* 移动端卡片样式 */
            .mobile-card {
                background-color: var(--card-bg);
                border-radius: 16px;
                padding: 16px;
                margin: 12px 0;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                border: 1px solid var(--border-color);
                transition: transform 0.2s ease;
            }
            
            .mobile-card:active {
                transform: scale(0.98);
            }
            
            /* 移动端数据警告优化 */
            .mobile-data-warning {
                background-color: var(--warning-bg);
                border-left: 4px solid #ff9800;
                padding: 16px;
                margin: 16px 0;
                border-radius: 12px;
                animation: slideIn 0.3s ease;
            }
            
            .mobile-data-warning h4 {
                color: #e65100;
                margin-bottom: 12px;
                font-size: 18px;
            }
            
            .mobile-data-warning ol {
                padding-left: 20px;
                margin: 12px 0;
            }
            
            .mobile-data-warning li {
                margin-bottom: 8px;
            }
            
            .mobile-data-actions {
                display: flex;
                gap: 12px;
                margin-top: 16px;
                flex-wrap: wrap;
            }
            
            .mobile-data-actions .mobile-btn {
                flex: 1;
                min-width: 120px;
            }
            
            .mobile-data-actions .export {
                background-color: #4caf50;
            }
            
            .mobile-data-actions .import {
                background-color: #2196f3;
            }
            
            /* 主题切换器样式 */
            .theme-switcher {
                position: fixed;
                bottom: 80px;
                right: 20px;
                z-index: 1000;
            }
            
            .theme-toggle-btn {
                width: 56px;
                height: 56px;
                border-radius: 50%;
                background-color: var(--primary-color);
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 20px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                cursor: pointer;
            }
            
            .theme-panel {
                position: absolute;
                bottom: 70px;
                right: 0;
                width: 280px;
                background-color: var(--card-bg);
                border-radius: 16px;
                padding: 20px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.15);
                display: none;
                border: 1px solid var(--border-color);
            }
            
            .theme-panel.show {
                display: block;
                animation: fadeIn 0.3s ease;
            }
            
            .theme-panel h4 {
                margin: 0 0 16px 0;
                color: var(--text-color);
            }
            
            .theme-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .theme-option {
                padding: 12px;
                border-radius: 12px;
                border: 2px solid var(--border-color);
                cursor: pointer;
                transition: all 0.2s ease;
                text-align: center;
            }
            
            .theme-option:hover {
                border-color: var(--primary-color);
                transform: translateY(-2px);
            }
            
            .theme-option.active {
                border-color: var(--primary-color);
                background-color: rgba(74, 111, 165, 0.1);
            }
            
            .theme-preview {
                width: 100%;
                height: 40px;
                border-radius: 8px;
                margin-bottom: 8px;
                border: 1px solid var(--border-color);
            }
            
            /* 性能优化类 */
            .will-change {
                will-change: transform, opacity;
            }
            
            /* 响应式优化 */
            @media (max-width: 480px) {
                .mobile-data-actions {
                    flex-direction: column;
                }
                
                .theme-panel {
                    width: calc(100vw - 40px);
                    right: -10px;
                }
                
                .theme-grid {
                    grid-template-columns: 1fr;
                }
            }
            
            /* 动画 */
            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateY(-20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            /* 滚动优化 */
            * {
                scrollbar-width: thin;
                scrollbar-color: var(--primary-color) transparent;
            }
            
            ::-webkit-scrollbar {
                width: 6px;
            }
            
            ::-webkit-scrollbar-track {
                background: transparent;
            }
            
            ::-webkit-scrollbar-thumb {
                background-color: var(--primary-color);
                border-radius: 20px;
            }
            
            /* 触摸设备优化 */
            @media (hover: none) and (pointer: coarse) {
                button, .btn, .mobile-btn {
                    padding: 14px 24px;
                }
                
                .mobile-card {
                    padding: 18px;
                }
            }
        `;
        
        document.head.appendChild(style);
    },
    
    createThemeSwitcher: function() {
        // 移除已存在的主题切换器
        const existing = document.querySelector('.theme-switcher');
        if (existing) existing.remove();
        
        const themeSwitcher = document.createElement('div');
        themeSwitcher.className = 'theme-switcher';
        themeSwitcher.innerHTML = `
            <div class="theme-toggle-btn" id="themeToggle">
                <i class="fas fa-palette"></i>
            </div>
            <div class="theme-panel" id="themePanel">
                <h4>选择主题样式</h4>
                <div class="theme-grid" id="themeGrid"></div>
            </div>
        `;
        
        document.body.appendChild(themeSwitcher);
        
        // 创建主题选项
        const themeGrid = document.getElementById('themeGrid');
        Object.keys(this.themes).forEach(themeKey => {
            const theme = this.themes[themeKey];
            const option = document.createElement('div');
            option.className = `theme-option ${themeKey === this.currentTheme ? 'active' : ''}`;
            option.setAttribute('data-theme', themeKey);
            
            // 创建主题预览
            const preview = document.createElement('div');
            preview.className = 'theme-preview';
            
            // 为主题预览设置背景渐变
            const colors = theme.variables;
            preview.style.background = `linear-gradient(135deg, 
                ${colors['--primary-color']} 0%, 
                ${colors['--secondary-color']} 50%, 
                ${colors['--card-bg']} 100%)`;
            
            option.appendChild(preview);
            option.appendChild(document.createTextNode(theme.name));
            
            option.onclick = () => {
                this.applyTheme(themeKey);
            };
            
            themeGrid.appendChild(option);
        });
        
        // 切换面板显示
        document.getElementById('themeToggle').onclick = (e) => {
            e.stopPropagation();
            const panel = document.getElementById('themePanel');
            panel.classList.toggle('show');
        };
        
        // 点击外部关闭面板
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.theme-switcher')) {
                document.getElementById('themePanel').classList.remove('show');
            }
        });
    },
    
    updateThemeSwitcherUI: function() {
        const options = document.querySelectorAll('.theme-option');
        options.forEach(option => {
            const themeKey = option.getAttribute('data-theme');
            option.classList.toggle('active', themeKey === this.currentTheme);
            
            // 更新预览背景
            const preview = option.querySelector('.theme-preview');
            const colors = this.themes[themeKey].variables;
            if (preview) {
                preview.style.background = `linear-gradient(135deg, 
                    ${colors['--primary-color']} 0%, 
                    ${colors['--secondary-color']} 50%, 
                    ${colors['--card-bg']} 100%)`;
            }
        });
    },
    
    // 添加性能优化方法
    optimizePerformance: function() {
        // 使用 requestAnimationFrame 优化动画
        const raf = window.requestAnimationFrame || 
                    window.webkitRequestAnimationFrame || 
                    window.mozRequestAnimationFrame || 
                    function(callback) { 
                        return setTimeout(callback, 1000 / 60); 
                    };
        
        // 节流函数，用于优化频繁触发的事件
        this.throttle = function(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        };
        
        // 防抖函数
        this.debounce = function(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        };
    },
    
    // 添加字体大小调整功能
    createFontSizeControls: function() {
        const fontSizeKey = 'mobileFontSize';
        const savedSize = localStorage.getItem(fontSizeKey) || 'medium';
        
        const sizes = {
            small: { name: '小号', size: '14px' },
            medium: { name: '中号', size: '16px' },
            large: { name: '大号', size: '18px' },
            xlarge: { name: '特大', size: '20px' }
        };
        
        // 应用字体大小
        this.applyFontSize = function(size = savedSize) {
            document.documentElement.style.fontSize = sizes[size].size;
            localStorage.setItem(fontSizeKey, size);
            this.updateFontSizeUI();
        };
        
        // 创建字体大小控制界面
        const createControls = () => {
            const container = document.createElement('div');
            container.className = 'font-size-controls';
            container.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 20px;
                z-index: 1000;
                background: var(--card-bg);
                border-radius: 12px;
                padding: 12px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                border: 1px solid var(--border-color);
            `;
            
            container.innerHTML = `
                <div style="margin-bottom: 8px; font-weight: bold; color: var(--text-color);">
                    字体大小
                </div>
                <div style="display: flex; gap: 8px;">
                    ${Object.keys(sizes).map(key => `
                        <button class="font-size-btn ${key === savedSize ? 'active' : ''}" 
                                data-size="${key}"
                                style="padding: 6px 12px; border-radius: 8px; border: 1px solid var(--border-color);">
                            ${sizes[key].name}
                        </button>
                    `).join('')}
                </div>
            `;
            
            document.body.appendChild(container);
            
            // 添加事件监听
            container.querySelectorAll('.font-size-btn').forEach(btn => {
                btn.onclick = () => {
                    const size = btn.getAttribute('data-size');
                    this.applyFontSize(size);
                };
            });
        };
        
        // 初始化
        this.applyFontSize();
        createControls();
        
        // 更新UI状态
        this.updateFontSizeUI = function() {
            const currentSize = localStorage.getItem(fontSizeKey) || 'medium';
            document.querySelectorAll('.font-size-btn').forEach(btn => {
                const size = btn.getAttribute('data-size');
                btn.classList.toggle('active', size === currentSize);
            });
        };
    }
};

// ==================== 增强版移动端数据管理组件 ====================
const MobileDataManager = {
    isMobile: function() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    },
    
    init: function() {
        if (!this.isMobile()) return;
        
        // 初始化样式管理器
        MobileStyleManager.init();
        
        // 添加移动端数据警告
        this.addDataWarning();
        
        // 添加自动备份提醒
        this.setupAutoBackupReminder();
        
        // 添加字体大小控制
        MobileStyleManager.createFontSizeControls();
        
        // 优化性能
        MobileStyleManager.optimizePerformance();
        
        // 添加触摸优化
        this.addTouchOptimizations();
        
        // 监听设备方向变化
        this.setupOrientationChange();
    },
    
    addDataWarning: function() {
        // 在页面加载时显示移动端数据警告
        setTimeout(() => {
            if (!sessionStorage.getItem('mobileDataWarningShown')) {
                const warningHtml = `
                    <div class="mobile-card mobile-data-warning">
                        <h4><i class="fas fa-exclamation-triangle"></i> 移动端使用提示</h4>
                        <p>在移动设备上，浏览器可能会定期清理本地存储数据。建议您：</p>
                        <ol>
                            <li>定期使用"数据管理"功能导出数据到文件</li>
                            <li>将导出的文件保存到云盘或手机存储</li>
                            <li>更换设备或浏览器时，导入之前保存的数据文件</li>
                        </ol>
                        <div class="mobile-data-actions">
                            <button class="mobile-btn export" onclick="UIManager.exportAllData()">
                                <i class="fas fa-download"></i> 立即导出数据
                            </button>
                            <button class="mobile-btn import" onclick="document.getElementById('mobile-file-input').click()">
                                <i class="fas fa-upload"></i> 导入数据文件
                            </button>
                            <button class="mobile-btn settings" onclick="MobileDataManager.showDataSettings()">
                                <i class="fas fa-cog"></i> 数据设置
                            </button>
                        </div>
                    </div>
                `;
                
                // 在内容区域顶部添加警告
                const contentArea = document.getElementById('content-area');
                if (contentArea) {
                    const loading = contentArea.querySelector('#loading');
                    if (loading) {
                        loading.insertAdjacentHTML('afterend', warningHtml);
                    } else {
                        contentArea.insertAdjacentHTML('afterbegin', warningHtml);
                    }
                }
                
                // 添加隐藏的文件输入
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.id = 'mobile-file-input';
                fileInput.accept = '.json';
                fileInput.style.display = 'none';
                fileInput.onchange = (e) => {
                    UIManager.importDataFromFile(e.target.files[0]);
                };
                document.body.appendChild(fileInput);
                
                sessionStorage.setItem('mobileDataWarningShown', 'true');
            }
        }, 1000);
    },
    
    setupAutoBackupReminder: function() {
        // 每24小时提醒备份一次
        const lastBackupReminder = localStorage.getItem('lastBackupReminder');
        const now = new Date().getTime();
        
        if (!lastBackupReminder || (now - lastBackupReminder) > 24 * 60 * 60 * 1000) {
            setTimeout(() => {
                // 创建更友好的提醒对话框
                const reminder = document.createElement('div');
                reminder.className = 'mobile-card';
                reminder.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    z-index: 10000;
                    width: 90%;
                    max-width: 400px;
                    background-color: var(--card-bg);
                    border-radius: 16px;
                    padding: 24px;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
                `;
                
                reminder.innerHTML = `
                    <h3 style="margin-top: 0;"><i class="fas fa-history"></i> 备份提醒</h3>
                    <p>距离上次数据备份已超过24小时，建议导出数据以防丢失。</p>
                    <div style="display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap;">
                        <button class="mobile-btn" style="background-color: #4caf50;" onclick="this.parentElement.parentElement.remove(); UIManager.exportAllData();">
                            <i class="fas fa-download"></i> 立即备份
                        </button>
                        <button class="mobile-btn" style="background-color: #757575;" onclick="this.parentElement.parentElement.remove();">
                            <i class="fas fa-clock"></i> 稍后提醒
                        </button>
                        <button class="mobile-btn" style="background-color: #f44336;" onclick="this.parentElement.parentElement.remove(); localStorage.setItem('lastBackupReminder', Date.now().toString());">
                            <i class="fas fa-ban"></i> 不再提醒
                        </button>
                    </div>
                `;
                
                document.body.appendChild(reminder);
                
                // 点击背景关闭
                const backdrop = document.createElement('div');
                backdrop.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background-color: rgba(0,0,0,0.5);
                    z-index: 9999;
                `;
                backdrop.onclick = () => {
                    reminder.remove();
                    backdrop.remove();
                };
                document.body.appendChild(backdrop);
                
                localStorage.setItem('lastBackupReminder', now.toString());
            }, 3000);
        }
    },
    
    checkDataIntegrity: function() {
        // 检查数据完整性
        const data = localStorage.getItem('structuredThoughtAssistant');
        if (!data) return { valid: false, reason: '无数据' };
        
        try {
            const parsed = JSON.parse(data);
            if (!parsed.thoughts || !parsed.models) {
                return { valid: false, reason: '数据结构不完整' };
            }
            return { valid: true, count: parsed.thoughts.length + parsed.models.length };
        } catch (e) {
            return { valid: false, reason: '数据损坏' };
        }
    },
    
    addTouchOptimizations: function() {
        // 防止双击缩放
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        
        // 优化滚动性能
        document.addEventListener('touchmove', function(event) {
            if (event.scale !== 1) {
                event.preventDefault();
            }
        }, { passive: false });
    },
    
    setupOrientationChange: function() {
        let timeout;
        window.addEventListener('orientationchange', () => {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                // 重新应用主题以保证样式正确
                MobileStyleManager.applyTheme();
            }, 100);
        });
    },
    
    showDataSettings: function() {
        // 创建数据管理设置面板
        const settingsHtml = `
            <div class="mobile-card" style="margin-top: 20px;">
                <h4><i class="fas fa-database"></i> 数据管理设置</h4>
                <div style="margin: 16px 0;">
                    <button class="mobile-btn" onclick="UIManager.exportAllData()" style="width: 100%; margin-bottom: 8px;">
                        <i class="fas fa-download"></i> 导出全部数据
                    </button>
                    <button class="mobile-btn" onclick="document.getElementById('mobile-file-input').click()" style="width: 100%; margin-bottom: 8px;">
                        <i class="fas fa-upload"></i> 导入数据文件
                    </button>
                    <button class="mobile-btn" onclick="MobileDataManager.clearAllData()" style="width: 100%; background-color: #f44336;">
                        <i class="fas fa-trash"></i> 清除所有数据
                    </button>
                </div>
                <div>
                    <h5>存储信息</h5>
                    <p>数据完整性检查: <span id="dataIntegrityStatus">检查中...</span></p>
                    <p>上次备份提醒: <span id="lastBackupTime">未记录</span></p>
                </div>
            </div>
        `;
        
        // 显示在内容区域
        const contentArea = document.getElementById('content-area');
        if (contentArea) {
            // 查找是否已有设置面板
            const existing = contentArea.querySelector('.data-settings-panel');
            if (existing) {
                existing.remove();
            }
            
            contentArea.insertAdjacentHTML('beforeend', settingsHtml);
            
            // 更新状态信息
            setTimeout(() => {
                const integrity = this.checkDataIntegrity();
                document.getElementById('dataIntegrityStatus').textContent = 
                    integrity.valid ? `正常 (${integrity.count} 项数据)` : `异常: ${integrity.reason}`;
                
                const lastBackup = localStorage.getItem('lastBackupReminder');
                if (lastBackup) {
                    const time = new Date(parseInt(lastBackup));
                    document.getElementById('lastBackupTime').textContent = 
                        time.toLocaleString();
                }
            }, 100);
        }
    },
    
    clearAllData: function() {
        if (confirm('确定要清除所有数据吗？此操作不可恢复！')) {
            localStorage.removeItem('structuredThoughtAssistant');
            localStorage.removeItem('lastBackupReminder');
            sessionStorage.removeItem('mobileDataWarningShown');
            UIManager.showAlert('所有数据已清除', 'success');
            setTimeout(() => location.reload(), 1500);
        }
    }
};

// 在 UIManager 中添加移动端导入方法
UIManager.importDataFromFile = function(file) {
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (event) => {
        try {
            const result = DataStore.importData(event.target.result);
            if (result.success) {
                this.showAlert('数据导入成功！', 'success');
                this.loadView(this.currentView);
                this.updateNetworkGraph();
                
                // 更新备份时间
                localStorage.setItem('lastBackupReminder', new Date().getTime().toString());
            } else {
                this.showAlert('导入失败：' + result.error, 'error');
            }
        } catch (error) {
            this.showAlert('文件格式错误：' + error.message, 'error');
        }
    };
    reader.readAsText(file);
};

// 页面加载完成后初始化移动端优化
document.addEventListener('DOMContentLoaded', function() {
    MobileDataManager.init();
    
    // 添加移动端特定的键盘优化
    if (MobileDataManager.isMobile()) {
        // 防止键盘弹出时页面布局错乱
        const inputs = document.querySelectorAll('input, textarea');
        inputs.forEach(input => {
            input.addEventListener('focus', function() {
                setTimeout(() => {
                    this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            });
        });
    }
});

// 添加快速操作按钮（浮动按钮）
setTimeout(() => {
    if (MobileDataManager.isMobile()) {
        const quickActions = document.createElement('div');
        quickActions.className = 'mobile-quick-actions';
        quickActions.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 90px;
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: 8px;
        `;
        
        quickActions.innerHTML = `
            <button class="quick-action-btn" onclick="UIManager.exportAllData()" 
                    style="width: 50px; height: 50px; border-radius: 50%; background-color: #4caf50; color: white; border: none; font-size: 20px;">
                <i class="fas fa-download"></i>
            </button>
            <button class="quick-action-btn" onclick="document.getElementById('mobile-file-input').click()"
                    style="width: 50px; height: 50px; border-radius: 50%; background-color: #2196f3; color: white; border: none; font-size: 20px;">
                <i class="fas fa-upload"></i>
            </button>
        `;
        
        document.body.appendChild(quickActions);
    }
}, 2000);
