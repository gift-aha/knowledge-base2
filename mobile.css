// ==================== 移动端优化组件 ====================
const MobileEnhancer = {
    // 当前主题配置
    currentTheme: 'light',
    
    // 可用主题列表
    themes: {
        light: {
            name: '明亮主题',
            backgroundColor: '#ffffff',
            textColor: '#333333',
            primaryColor: '#3498db',
            secondaryColor: '#2ecc71',
            cardBg: '#f8f9fa',
            borderColor: '#e0e0e0'
        },
        dark: {
            name: '深色主题',
            backgroundColor: '#1a1a1a',
            textColor: '#f0f0f0',
            primaryColor: '#2980b9',
            secondaryColor: '#27ae60',
            cardBg: '#2d2d2d',
            borderColor: '#404040'
        },
        nature: {
            name: '自然主题',
            backgroundColor: '#f5f9f1',
            textColor: '#2c3e50',
            primaryColor: '#27ae60',
            secondaryColor: '#3498db',
            cardBg: '#ffffff',
            borderColor: '#d5e8d3'
        },
        compact: {
            name: '紧凑模式',
            backgroundColor: '#ffffff',
            textColor: '#333333',
            primaryColor: '#3498db',
            secondaryColor: '#2ecc71',
            cardBg: '#ffffff',
            borderColor: '#e0e0e0',
            compact: true
        }
    },

    init: function() {
        if (!this.isMobile()) return;
        
        // 1. 检查并修复数据一致性问题
        this.fixDataConsistency();
        
        // 2. 设置可隐藏的导航栏
        this.setupCollapsibleNavbar();
        
        // 3. 初始化主题系统
        this.initThemeSystem();
        
        // 4. 添加移动端优化样式
        this.addMobileStyles();
        
        // 5. 性能优化
        this.performanceOptimization();
    },
    
    // 数据一致性修复
    fixDataConsistency: function() {
        // 检查PC端和移动端数据差异
        const mobileData = localStorage.getItem('structuredThoughtAssistant');
        const pcData = sessionStorage.getItem('pcThoughtData');
        
        if (!mobileData && pcData) {
            // 如果移动端没有数据但PC端有，导入PC端数据
            localStorage.setItem('structuredThoughtAssistant', pcData);
            console.log('已从PC端同步数据');
        } else if (mobileData && pcData) {
            // 比较数据时间戳，使用最新的
            const mobileJson = JSON.parse(mobileData);
            const pcJson = JSON.parse(pcData);
            
            if (pcJson.lastModified > mobileJson.lastModified) {
                localStorage.setItem('structuredThoughtAssistant', pcData);
                console.log('已更新为PC端数据');
            }
        }
        
        // 清理多余的数据字段（针对移动端特有的临时数据）
        this.cleanUpMobileTempData();
    },
    
    cleanUpMobileTempData: function() {
        // 清理移动端特有的临时数据
        const tempKeys = [
            'mobile_draft_thought',
            'mobile_unsaved_changes',
            'mobile_temp_cache'
        ];
        
        tempKeys.forEach(key => {
            localStorage.removeItem(key);
            sessionStorage.removeItem(key);
        });
    },
    
    // 可隐藏导航栏系统
    setupCollapsibleNavbar: function() {
        // 创建可隐藏的导航栏容器
        const navHTML = `
            <div class="mobile-nav-container">
                <div class="mobile-nav-header">
                    <button class="mobile-nav-toggle" id="mobileNavToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <span class="mobile-nav-title">思维助手</span>
                    <button class="mobile-theme-toggle" id="mobileThemeToggle">
                        <i class="fas fa-palette"></i>
                    </button>
                </div>
                
                <div class="mobile-nav-content" id="mobileNavContent">
                    <!-- 导航内容将通过JS动态生成 -->
                </div>
                
                <div class="mobile-nav-overlay" id="mobileNavOverlay"></div>
            </div>
        `;
        
        // 插入导航栏
        const contentArea = document.getElementById('content-area');
        if (contentArea) {
            contentArea.insertAdjacentHTML('beforebegin', navHTML);
        } else {
            document.body.insertAdjacentHTML('afterbegin', navHTML);
        }
        
        // 生成导航内容
        this.generateNavContent();
        
        // 绑定事件
        this.bindNavEvents();
        
        // 默认隐藏导航栏
        this.setNavbarVisible(false);
    },
    
    generateNavContent: function() {
        const navContent = document.getElementById('mobileNavContent');
        if (!navContent) return;
        
        // 生成主要功能链接
        const navItems = [
            { id: 'thoughts', icon: 'fas fa-lightbulb', text: '我的思维', action: () => UIManager.loadView('thoughts') },
            { id: 'models', icon: 'fas fa-cube', text: '思维模型', action: () => UIManager.loadView('models') },
            { id: 'graph', icon: 'fas fa-project-diagram', text: '关系图谱', action: () => UIManager.loadView('graph') },
            { id: 'statistics', icon: 'fas fa-chart-bar', text: '数据统计', action: () => UIManager.loadView('statistics') },
            { id: 'settings', icon: 'fas fa-cog', text: '设置', action: () => this.showSettings() },
            { id: 'export', icon: 'fas fa-download', text: '导出数据', action: () => UIManager.exportAllData() },
            { id: 'import', icon: 'fas fa-upload', text: '导入数据', action: () => document.getElementById('mobile-file-input').click() },
            { id: 'themes', icon: 'fas fa-palette', text: '主题切换', action: () => this.showThemeSelector() }
        ];
        
        const navHTML = `
            <div class="mobile-nav-items">
                ${navItems.map(item => `
                    <div class="mobile-nav-item" data-action="${item.id}">
                        <i class="${item.icon}"></i>
                        <span>${item.text}</span>
                    </div>
                `).join('')}
            </div>
            
            <div class="mobile-nav-footer">
                <div class="mobile-data-info" id="mobileDataInfo">
                    <i class="fas fa-database"></i>
                    <span>加载数据中...</span>
                </div>
                <button class="mobile-nav-hide" id="mobileNavHide">
                    <i class="fas fa-chevron-left"></i> 隐藏导航
                </button>
            </div>
        `;
        
        navContent.innerHTML = navHTML;
        
        // 绑定导航项点击事件
        navItems.forEach(item => {
            const element = navContent.querySelector(`[data-action="${item.id}"]`);
            if (element) {
                element.addEventListener('click', () => {
                    item.action();
                    this.setNavbarVisible(false);
                });
            }
        });
        
        // 更新数据信息
        this.updateDataInfo();
    },
    
    bindNavEvents: function() {
        const toggleBtn = document.getElementById('mobileNavToggle');
        const hideBtn = document.getElementById('mobileNavHide');
        const overlay = document.getElementById('mobileNavOverlay');
        const themeToggle = document.getElementById('mobileThemeToggle');
        
        if (toggleBtn) {
            toggleBtn.addEventListener('click', () => this.toggleNavbar());
        }
        
        if (hideBtn) {
            hideBtn.addEventListener('click', () => this.setNavbarVisible(false));
        }
        
        if (overlay) {
            overlay.addEventListener('click', () => this.setNavbarVisible(false));
        }
        
        if (themeToggle) {
            themeToggle.addEventListener('click', () => this.showThemeSelector());
        }
        
        // 添加滑动关闭支持
        let touchStartX = 0;
        const navContent = document.getElementById('mobileNavContent');
        
        if (navContent) {
            navContent.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
            });
            
            navContent.addEventListener('touchmove', (e) => {
                const touchX = e.touches[0].clientX;
                const diff = touchStartX - touchX;
                
                if (diff > 50) { // 向右滑动超过50px
                    this.setNavbarVisible(false);
                }
            });
        }
    },
    
    toggleNavbar: function() {
        const navContent = document.getElementById('mobileNavContent');
        const overlay = document.getElementById('mobileNavOverlay');
        
        if (navContent && overlay) {
            const isVisible = navContent.classList.contains('visible');
            this.setNavbarVisible(!isVisible);
        }
    },
    
    setNavbarVisible: function(visible) {
        const navContent = document.getElementById('mobileNavContent');
        const overlay = document.getElementById('mobileNavOverlay');
        
        if (navContent && overlay) {
            if (visible) {
                navContent.classList.add('visible');
                overlay.classList.add('visible');
                document.body.style.overflow = 'hidden';
            } else {
                navContent.classList.remove('visible');
                overlay.classList.remove('visible');
                document.body.style.overflow = '';
            }
        }
    },
    
    // 主题系统
    initThemeSystem: function() {
        // 加载保存的主题
        const savedTheme = localStorage.getItem('mobileTheme') || 'light';
        this.applyTheme(savedTheme);
        
        // 创建主题CSS变量
        this.createThemeCSS();
    },
    
    createThemeCSS: function() {
        // 动态创建CSS变量
        const style = document.createElement('style');
        style.id = 'mobile-theme-variables';
        document.head.appendChild(style);
        
        // 初始应用主题
        this.updateThemeVariables();
    },
    
    updateThemeVariables: function() {
        const theme = this.themes[this.currentTheme];
        const styleElement = document.getElementById('mobile-theme-variables');
        
        if (!styleElement) return;
        
        const cssVariables = `
            :root {
                --mobile-bg-color: ${theme.backgroundColor};
                --mobile-text-color: ${theme.textColor};
                --mobile-primary-color: ${theme.primaryColor};
                --mobile-secondary-color: ${theme.secondaryColor};
                --mobile-card-bg: ${theme.cardBg};
                --mobile-border-color: ${theme.borderColor};
            }
            
            ${theme.compact ? `
                .mobile-content-item { padding: 8px 12px; }
                .mobile-card { margin-bottom: 8px; }
                .mobile-btn { padding: 6px 12px; font-size: 13px; }
            ` : ''}
        `;
        
        styleElement.innerHTML = cssVariables;
    },
    
    applyTheme: function(themeName) {
        if (this.themes[themeName]) {
            this.currentTheme = themeName;
            localStorage.setItem('mobileTheme', themeName);
            
            // 更新CSS变量
            this.updateThemeVariables();
            
            // 添加主题类到body
            document.body.classList.remove(...Object.keys(this.themes));
            document.body.classList.add(`theme-${themeName}`);
            
            return true;
        }
        return false;
    },
    
    showThemeSelector: function() {
        const selectorHTML = `
            <div class="mobile-theme-selector">
                <div class="theme-selector-header">
                    <h4><i class="fas fa-palette"></i> 选择主题</h4>
                    <button class="theme-selector-close" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="theme-options">
                    ${Object.entries(this.themes).map(([key, theme]) => `
                        <div class="theme-option ${key === this.currentTheme ? 'active' : ''}" 
                             data-theme="${key}"
                             style="--theme-bg:${theme.backgroundColor};--theme-text:${theme.textColor};">
                            <div class="theme-preview">
                                <div class="theme-color primary" style="background-color:${theme.primaryColor}"></div>
                                <div class="theme-color secondary" style="background-color:${theme.secondaryColor}"></div>
                                <div class="theme-color card" style="background-color:${theme.cardBg}"></div>
                            </div>
                            <div class="theme-info">
                                <h5>${theme.name}</h5>
                                ${key === this.currentTheme ? '<span class="current-badge">当前</span>' : ''}
                            </div>
                            <button class="theme-select-btn" onclick="MobileEnhancer.applyTheme('${key}')">
                                ${key === this.currentTheme ? '<i class="fas fa-check"></i>' : '应用'}
                            </button>
                        </div>
                    `).join('')}
                </div>
                <div class="theme-custom-options">
                    <h5><i class="fas fa-sliders-h"></i> 自定义选项</h5>
                    <div class="custom-option">
                        <label>字体大小</label>
                        <select id="fontSizeSelect" onchange="MobileEnhancer.setFontSize(this.value)">
                            <option value="small">小号</option>
                            <option value="medium" selected>中号</option>
                            <option value="large">大号</option>
                        </select>
                    </div>
                    <div class="custom-option">
                        <label>行间距</label>
                        <select id="lineHeightSelect" onchange="MobileEnhancer.setLineHeight(this.value)">
                            <option value="tight">紧凑</option>
                            <option value="normal" selected>正常</option>
                            <option value="loose">宽松</option>
                        </select>
                    </div>
                </div>
            </div>
        `;
        
        // 移除现有的选择器
        const existing = document.querySelector('.mobile-theme-selector');
        if (existing) existing.remove();
        
        // 添加新的选择器
        document.body.insertAdjacentHTML('beforeend', selectorHTML);
        
        // 点击背景关闭
        const selector = document.querySelector('.mobile-theme-selector');
        selector.addEventListener('click', (e) => {
            if (e.target === selector) {
                selector.remove();
            }
        });
    },
    
    setFontSize: function(size) {
        const sizes = {
            small: '13px',
            medium: '16px',
            large: '18px'
        };
        
        document.documentElement.style.setProperty('--mobile-font-size', sizes[size] || '16px');
        localStorage.setItem('mobileFontSize', size);
    },
    
    setLineHeight: function(height) {
        const heights = {
            tight: '1.3',
            normal: '1.5',
            loose: '1.8'
        };
        
        document.documentElement.style.setProperty('--mobile-line-height', heights[height] || '1.5');
        localStorage.setItem('mobileLineHeight', height);
    },
    
    // 性能优化
    performanceOptimization: function() {
        // 延迟加载图片
        this.lazyLoadImages();
        
        // 使用防抖处理滚动事件
        this.debounceScroll();
        
        // 优化长列表渲染
        this.optimizeListRendering();
    },
    
    lazyLoadImages: function() {
        if ('IntersectionObserver' in window) {
            const imageObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        imageObserver.unobserve(img);
                    }
                });
            });
            
            document.querySelectorAll('img[data-src]').forEach(img => {
                imageObserver.observe(img);
            });
        }
    },
    
    debounceScroll: function() {
        let ticking = false;
        window.addEventListener('scroll', () => {
            if (!ticking) {
                window.requestAnimationFrame(() => {
                    // 处理滚动事件
                    ticking = false;
                });
                ticking = true;
            }
        });
    },
    
    optimizeListRendering: function() {
        // 虚拟滚动容器的实现
        // 这里可以根据实际内容长度实现虚拟滚动
    },
    
    // 移动端样式
    addMobileStyles: function() {
        const style = document.createElement('style');
        style.textContent = `
            /* 移动端基础样式 */
            :root {
                --mobile-font-size: 16px;
                --mobile-line-height: 1.5;
            }
            
            body.mobile-optimized {
                font-size: var(--mobile-font-size);
                line-height: var(--mobile-line-height);
                background-color: var(--mobile-bg-color);
                color: var(--mobile-text-color);
            }
            
            /* 可隐藏导航栏样式 */
            .mobile-nav-container {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                z-index: 1000;
            }
            
            .mobile-nav-header {
                display: flex;
                align-items: center;
                padding: 12px 15px;
                background-color: var(--mobile-primary-color);
                color: white;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            
            .mobile-nav-toggle, .mobile-theme-toggle {
                background: none;
                border: none;
                color: white;
                font-size: 20px;
                padding: 8px;
                cursor: pointer;
            }
            
            .mobile-nav-title {
                flex: 1;
                font-size: 18px;
                font-weight: bold;
                text-align: center;
            }
            
            .mobile-nav-content {
                position: fixed;
                top: 0;
                left: -280px;
                width: 280px;
                height: 100vh;
                background-color: var(--mobile-card-bg);
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
                transition: left 0.3s ease;
                z-index: 1001;
                display: flex;
                flex-direction: column;
            }
            
            .mobile-nav-content.visible {
                left: 0;
            }
            
            .mobile-nav-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                z-index: 1000;
                display: none;
            }
            
            .mobile-nav-overlay.visible {
                display: block;
            }
            
            .mobile-nav-items {
                flex: 1;
                overflow-y: auto;
                padding: 20px 0;
            }
            
            .mobile-nav-item {
                display: flex;
                align-items: center;
                padding: 15px 20px;
                color: var(--mobile-text-color);
                text-decoration: none;
                cursor: pointer;
                transition: background-color 0.2s;
            }
            
            .mobile-nav-item:hover {
                background-color: rgba(0,0,0,0.05);
            }
            
            .mobile-nav-item i {
                width: 24px;
                margin-right: 15px;
                color: var(--mobile-primary-color);
            }
            
            .mobile-nav-footer {
                padding: 15px;
                border-top: 1px solid var(--mobile-border-color);
            }
            
            .mobile-data-info {
                display: flex;
                align-items: center;
                margin-bottom: 10px;
                font-size: 14px;
                color: var(--mobile-text-color);
            }
            
            .mobile-data-info i {
                margin-right: 8px;
                color: var(--mobile-secondary-color);
            }
            
            .mobile-nav-hide {
                width: 100%;
                padding: 10px;
                background-color: var(--mobile-secondary-color);
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
            }
            
            /* 主题选择器样式 */
            .mobile-theme-selector {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.7);
                z-index: 1100;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .mobile-theme-selector > div {
                background-color: var(--mobile-card-bg);
                border-radius: 10px;
                width: 90%;
                max-width: 400px;
                max-height: 80vh;
                overflow-y: auto;
            }
            
            .theme-selector-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px;
                border-bottom: 1px solid var(--mobile-border-color);
            }
            
            .theme-options {
                padding: 15px;
            }
            
            .theme-option {
                display: flex;
                align-items: center;
                padding: 12px;
                margin-bottom: 10px;
                border: 2px solid var(--mobile-border-color);
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.2s;
            }
            
            .theme-option.active {
                border-color: var(--mobile-primary-color);
            }
            
            .theme-preview {
                display: flex;
                margin-right: 15px;
            }
            
            .theme-color {
                width: 20px;
                height: 20px;
                border-radius: 4px;
                margin-right: 4px;
            }
            
            .theme-info {
                flex: 1;
            }
            
            .current-badge {
                background-color: var(--mobile-secondary-color);
                color: white;
                padding: 2px 8px;
                border-radius: 10px;
                font-size: 12px;
                margin-left: 8px;
            }
            
            .theme-select-btn {
                background-color: var(--mobile-primary-color);
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 4px;
                cursor: pointer;
            }
            
            /* 移动端内容优化 */
            #content-area {
                margin-top: 60px;
                padding: 15px;
            }
            
            .mobile-content-item {
                margin-bottom: 15px;
                padding: 15px;
                background-color: var(--mobile-card-bg);
                border-radius: 8px;
                border: 1px solid var(--mobile-border-color);
            }
            
            .mobile-btn {
                padding: 10px 15px;
                border-radius: 5px;
                border: none;
                font-size: 14px;
                cursor: pointer;
                transition: opacity 0.2s;
            }
            
            .mobile-btn:active {
                opacity: 0.8;
            }
            
            /* 响应式调整 */
            @media (max-width: 480px) {
                .mobile-nav-content {
                    width: 100%;
                    left: -100%;
                }
                
                #content-area {
                    padding: 10px;
                }
            }
            
            /* 动画效果 */
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            .mobile-content-item {
                animation: fadeIn 0.3s ease;
            }
        `;
        
        document.head.appendChild(style);
        
        // 添加移动端优化类
        document.body.classList.add('mobile-optimized');
    },
    
    updateDataInfo: function() {
        const dataInfo = document.getElementById('mobileDataInfo');
        if (!dataInfo) return;
        
        const checkResult = MobileDataManager.checkDataIntegrity();
        if (checkResult.valid) {
            dataInfo.innerHTML = `
                <i class="fas fa-database"></i>
                <span>数据正常 (${checkResult.count}条记录)</span>
            `;
        } else {
            dataInfo.innerHTML = `
                <i class="fas fa-exclamation-circle" style="color:#e74c3c"></i>
                <span>数据异常: ${checkResult.reason}</span>
            `;
        }
    },
    
    showSettings: function() {
        // 显示移动端设置面板
        const settingsHTML = `
            <div class="mobile-settings-panel">
                <h4><i class="fas fa-cog"></i> 移动端设置</h4>
                <div class="settings-group">
                    <label>
                        <input type="checkbox" id="autoSyncData" checked>
                        自动同步数据
                    </label>
                    <label>
                        <input type="checkbox" id="enableAnimations" checked>
                        启用动画效果
                    </label>
                    <label>
                        <input type="checkbox" id="reduceMotion">
                        减少动画（无障碍）
                    </label>
                </div>
                <div class="settings-group">
                    <button class="mobile-btn" onclick="MobileEnhancer.clearCache()">
                        <i class="fas fa-trash"></i> 清理缓存
                    </button>
                    <button class="mobile-btn" onclick="MobileEnhancer.resetSettings()">
                        <i class="fas fa-redo"></i> 恢复默认设置
                    </button>
                </div>
            </div>
        `;
        
        // 这里可以弹出一个设置面板
        alert('移动端设置功能');
    },
    
    clearCache: function() {
        if (confirm('确定要清理缓存吗？这不会删除您的数据。')) {
            // 清理缓存
            caches.keys().then(cacheNames => {
                cacheNames.forEach(cacheName => {
                    caches.delete(cacheName);
                });
            });
            localStorage.removeItem('mobileCache');
            sessionStorage.clear();
            this.showAlert('缓存已清理', 'success');
        }
    },
    
    resetSettings: function() {
        if (confirm('确定要恢复默认设置吗？')) {
            localStorage.removeItem('mobileTheme');
            localStorage.removeItem('mobileFontSize');
            localStorage.removeItem('mobileLineHeight');
            this.applyTheme('light');
            this.showAlert('设置已恢复默认', 'success');
        }
    },
    
    showAlert: function(message, type = 'info') {
        // 简单的移动端提醒
        const alertDiv = document.createElement('div');
        alertDiv.className = `mobile-alert mobile-alert-${type}`;
        alertDiv.textContent = message;
        alertDiv.style.cssText = `
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            background-color: ${type === 'success' ? '#2ecc71' : type === 'error' ? '#e74c3c' : '#3498db'};
            color: white;
            border-radius: 5px;
            z-index: 9999;
            animation: fadeIn 0.3s, fadeOut 0.3s 2.7s;
        `;
        
        document.body.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 3000);
    },
    
    // 工具方法
    isMobile: function() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
};

// 初始化移动端优化
document.addEventListener('DOMContentLoaded', function() {
    if (MobileEnhancer.isMobile()) {
        MobileEnhancer.init();
        
        // 监听页面可见性变化，当页面重新显示时检查数据
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                MobileEnhancer.updateDataInfo();
            }
        });
    }
});

// 与原有MobileDataManager集成
MobileDataManager.init = function() {
    if (!this.isMobile()) return;
    
    // 先执行原有的初始化
    this.addDataWarning();
    this.setupAutoBackupReminder();
    
    // 然后执行移动端优化
    MobileEnhancer.init();
};

// 确保MobileDataManager的其他方法仍然可用
MobileDataManager.checkDataIntegrity = function() {
    // 原有的数据完整性检查逻辑
    const data = localStorage.getItem('structuredThoughtAssistant');
    if (!data) return { valid: false, reason: '无数据' };
    
    try {
        const parsed = JSON.parse(data);
        if (!parsed.thoughts || !parsed.models) {
            return { valid: false, reason: '数据结构不完整' };
        }
        return { valid: true, count: parsed.thoughts.length + parsed.models.length };
    } catch (e) {
        return { valid: false, reason: '数据损坏' };
    }
};
